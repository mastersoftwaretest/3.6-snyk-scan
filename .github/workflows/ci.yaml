name: CI Checks
run-name: Running Terraform & Snyk Checks by ${{ github.actor }}

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  #####################################
  # Initial Info Job
  #####################################
  Initial-Checks:
    runs-on: ubuntu-latest
    steps:
      - name: Getting initiator name
        run: echo "Workflow initiated by ${{ github.actor }} from branch ${{ github.ref_name }}"

  #####################################
  # Terraform Validation & Lint Checks
  #####################################
  terraform-checks:
    runs-on: ubuntu-latest
    needs: Initial-Checks
    outputs:
      status: ${{ job.status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform fmt
        id: fmt
        run: terraform fmt -check

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - uses: terraform-linters/setup-tflint@v3
        with:
          tflint_version: latest

      - name: Show version
        run: tflint --version

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint
        run: tflint -f compact

  #####################################
  # Snyk Checks: Code, IaC, Container
  #####################################
  snyk-checks:
    runs-on: ubuntu-latest
    needs: terraform-checks
    outputs:
      status: ${{ job.status }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Node.js (for snyk)
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Snyk Auth
        run: snyk auth ${{ secrets.SNYK_TOKEN }}

      - name: Snyk Code Scan
        run: snyk code test --severity-threshold=high
        continue-on-error: true

      - name: Snyk IaC Scan
        run: snyk iac test --report
        continue-on-error: true

      # Optional: if you have a Docker image to test
      - name: Snyk Container Scan
        run: snyk container test --file=Dockerfile || echo "No container image found"

  #####################################
  # Summary of all checks
  #####################################
  summary:
    needs: [terraform-checks, snyk-checks]
    runs-on: ubuntu-latest
    steps:
      - name: Adding markdown summary
        run: |
          TF_STATUS=${{ needs.terraform-checks.outputs.status }}
          SNYK_STATUS=${{ needs.snyk-checks.outputs.status }}

          echo '## âœ… Build Summary' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo "| Job Name | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Checks | $TF_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| Snyk Checks | $SNYK_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo "Workflow executed by: **${{ github.actor }}**" >> $GITHUB_STEP_SUMMARY
